<!-- 1.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Flashcards</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        :root {
            --orange: rgb(251, 146, 60); --green: rgb(16, 185, 129); --background: #f0f7ff;
            --text-dark: #1e293b; --text-light: #64748b; --card-bg: #ffffff;
            --hint-bg: #f8fafc;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--background); color: var(--text-dark); overflow: hidden; }
        .app-wrapper { display: flex; flex-direction: column; height: 100vh; }
        .app-header { padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .header-info h1 { font-size: 1.25rem; font-weight: 700; margin: 0; }
        .header-info p { font-size: 0.875rem; color: var(--text-light); margin: 0.25rem 0 0 0; }
        #close-btn { width: 36px; height: 36px; border-radius: 50%; background-color: #e2e8f0; border: none; font-size: 1.5rem; color: var(--text-light); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        .card-area {
            flex-grow: 1; display: flex; align-items: center; justify-content: center;
            padding: 0 1.5rem 5rem; position: relative;
        }
        .flashcard {
            width: 100%; max-width: 400px; height: 60vh; max-height: 450px;
            position: absolute; transform-style: preserve-3d;
            cursor: pointer; will-change: transform, opacity;
            opacity: 0;
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .flashcard.flipped { transform: rotateY(180deg) !important; }
        .card-face {
            position: absolute; height: 100%; width: 100%;
            backface-visibility: hidden; display: flex; flex-direction: column;
            background-color: var(--card-bg); border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .color-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 24px; opacity: 0;
            transition: opacity 0.4s ease;
        }
        .card-front-content {
            flex-grow: 1; display: flex; align-items: center; justify-content: center;
            padding: 2rem 2rem 0; text-align: center; overflow-y: auto;
        }
        .question-text { font-size: 1.75rem; font-weight: 500; line-height: 1.4; }
        .hint-reveal-btn { background: none; border: none; color: #007bff; font-weight: 500; font-size: 0.875rem; letter-spacing: 0.5px; cursor: pointer; padding: 1.5rem; width: 100%; }
        .hint-container {
            display: none; width: 100%; padding: 1.5rem; margin-top: auto;
            background-color: var(--hint-bg); border-top: 1px solid #e2e8f0;
            text-align: left;
        }
        .hint-container h4 { margin: 0 0 0.25rem 0; font-size: 0.75rem; color: var(--text-light); letter-spacing: 1px; font-weight: 700; }
        .hint-container p { margin: 0; font-size: 1rem; color: var(--text-dark); }
        .card-back { transform: rotateY(180deg); align-items: center; justify-content: center; padding: 2rem; text-align: center; overflow-y: auto; }
        .answer-title {
            color: var(--text-light); font-size: 0.75rem; font-weight: 700;
            letter-spacing: 1px; margin-bottom: 1rem; position: relative; width: 100%;
        }
        .answer-title::before {
            content: ''; position: absolute; top: -1rem; left: 50%;
            transform: translateX(-50%); width: 30px; height: 2px;
            background-color: #e2e8f0;
        }
        .answer-text { font-size: 1.25rem; line-height: 1.6; }

        @keyframes deal-in {
            from { opacity: 0; transform: translateY(100vh) rotate(45deg); }
            to { opacity: 1; }
        }
        
        .controls-footer { padding: 1.5rem; display: flex; gap: 1rem; justify-content: center; flex-shrink: 0; }
        .control-btn { flex-grow: 1; max-width: 200px; padding: 1rem; border-radius: 999px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s, color 0.2s; background-color: var(--card-bg); border: 2px solid; }
        .btn-learning { border-color: var(--orange); color: var(--orange); }
        .btn-know { border-color: var(--green); color: var(--green); }
    </style>
</head>
<body>
    <div class="app-wrapper" id="main-container">
        <header class="app-header"><div class="header-info"><h1 id="chapter-title">Loading...</h1><p id="progress-counter">Loading cards...</p></div><button id="close-btn">Ã—</button></header>
        <main class="card-area" id="card-area"></main>
        <footer class="controls-footer"><button id="learn-btn" class="control-btn btn-learning">Still learning</button><button id="know-btn" class="control-btn btn-know">I know this</button></footer>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="firebase-init.js"></script>
    <script>
        // DOM Elements & State
        const mainContainer = document.getElementById('main-container'), chapterTitleEl = document.getElementById('chapter-title'), progressCounterEl = document.getElementById('progress-counter'), cardArea = document.getElementById('card-area'), knowBtn = document.getElementById('know-btn'), learnBtn = document.getElementById('learn-btn'), closeBtn = document.getElementById('close-btn');
        let allCards = [], currentIndex = 0, knowCount = 0, learningCount = 0, isAnimating = false;

        function createCardElement(cardData) {
            const cardEl = document.createElement('div');
            cardEl.className = 'flashcard';
            const hintHTML = cardData.hint ? `<button class="hint-reveal-btn">SHOW HINT</button><div class="hint-container"><h4>HINT</h4><p>${cardData.hint}</p></div>` : '<div style="padding: 1.5rem;"></div>';
            cardEl.innerHTML = `<div class="color-overlay"></div><div class="card-face card-front"><div class="card-front-content"><p class="question-text">${cardData.question}</p></div>${hintHTML}</div><div class="card-face card-back"><div class="answer-title">ANSWER</div><p class="answer-text">${cardData.answer}</p></div>`;
            return cardEl;
        }

        function renderCardStack(isInitialLoad = false) {
            cardArea.innerHTML = '';
            const cardsToShow = allCards.slice(currentIndex, currentIndex + 3).reverse();

            cardsToShow.forEach((cardData, indexInStack) => {
                const cardEl = createCardElement(cardData);
                const stackPosition = cardsToShow.length - 1 - indexInStack;
                cardEl.style.transform = `scale(${1 - (stackPosition * 0.05)}) translateY(${stackPosition * -15}px)`;
                cardEl.style.zIndex = allCards.length - indexInStack;
                if (isInitialLoad) {
                    cardEl.style.animation = `deal-in 0.6s ${indexInStack * 0.1}s forwards cubic-bezier(0.25, 0.46, 0.45, 0.94)`;
                } else {
                    cardEl.style.opacity = '1';
                }
                cardArea.appendChild(cardEl);
                if (stackPosition === 0) addInteractionHandlers(cardEl);
            });
        }
        
        function addInteractionHandlers(cardEl) {
            const overlay = cardEl.querySelector('.color-overlay');
            const hammer = new Hammer(cardEl);

            // Use Hammer's 'tap' event for flipping to avoid conflicts with 'pan'
            hammer.on('tap', (e) => {
                if (e.target.classList.contains('hint-reveal-btn')) return;
                if (!isAnimating) cardEl.classList.toggle('flipped');
            });

            // Standard click listener for the hint button is fine
            const hintBtn = cardEl.querySelector('.hint-reveal-btn');
            if (hintBtn) {
                hintBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // CRITICAL: Prevents the tap event from firing on the card
                    hintBtn.style.display = 'none';
                    cardEl.querySelector('.hint-container').style.display = 'block';
                });
            }

            hammer.on('pan', (e) => {
                if (isAnimating) return;
                cardEl.classList.remove('flipped');
                cardEl.style.transition = 'none';
                const rotation = e.deltaX / 20;
                cardEl.style.transform = `translateX(${e.deltaX}px) rotate(${rotation}deg)`;
                
                const opacity = Math.min(Math.abs(e.deltaX) / 150, 0.8);
                overlay.style.transition = 'none';
                overlay.style.opacity = opacity;
                overlay.style.backgroundColor = e.deltaX > 0 ? 'var(--green)' : 'var(--orange)';
                
                if (e.isFinal) {
                    cardEl.style.transition = 'transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1)';
                    overlay.style.transition = 'opacity 0.4s ease';
                    const swipeThreshold = 120;
                    if (Math.abs(e.deltaX) > swipeThreshold) {
                        const direction = e.deltaX > 0 ? 'know' : 'learn';
                        animateSwipeOut(cardEl, direction);
                        processResult(direction);
                    } else {
                        cardEl.style.transform = 'scale(1) translateY(0)';
                        overlay.style.opacity = 0;
                    }
                }
            });
        }

        function animateSwipeOut(cardEl, direction) {
            isAnimating = true;
            const endX = direction === 'know' ? 500 : -500, rotation = direction === 'know' ? 30 : -30;
            cardEl.style.transform = `translateX(${endX}px) rotate(${rotation}deg)`;
            cardEl.style.opacity = 0;
        }

        function processResult(direction) {
            (direction === 'know') ? knowCount++ : learningCount++;
            currentIndex++;
            progressCounterEl.textContent = `${currentIndex >= allCards.length ? allCards.length : currentIndex + 1} of ${allCards.length} cards`;

            setTimeout(() => {
                isAnimating = false;
                if (currentIndex >= allCards.length) goToScorePage(); else renderCardStack();
            }, 400);
        }

        function goToScorePage() {
            localStorage.setItem('knowCount', knowCount);
            localStorage.setItem('learningCount', learningCount);
            window.location.href = '2.html';
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            const code = new URLSearchParams(window.location.search).get('code');
            if (!code) { mainContainer.innerHTML = '<h1>Error: No code found in URL.</h1>'; return; }
            localStorage.setItem('lastCode', code);
            try {
                const docSnap = await db.collection('flashcardSets').doc(code).get();
                if (docSnap.exists && docSnap.data().cards && docSnap.data().cards.length > 0) {
                    const data = docSnap.data();
                    chapterTitleEl.textContent = data.chapter;
                    allCards = data.cards;
                    progressCounterEl.textContent = `1 of ${allCards.length} cards`;
                    renderCardStack(true);
                } else {
                     mainContainer.innerHTML = '<h1>Error: Set not found or is empty.</h1>';
                }
            } catch (error) { console.error("Error fetching document:", error); mainContainer.innerHTML = '<h1>Error loading flashcards.</h1>'; }
        });
        
        knowBtn.addEventListener('click', () => { if (!isAnimating) { const activeCard = cardArea.querySelector('.flashcard:last-child'); if (activeCard) { animateSwipeOut(activeCard, 'know'); processResult('know'); } } });
        learnBtn.addEventListener('click', () => { if (!isAnimating) { const activeCard = cardArea.querySelector('.flashcard:last-child'); if (activeCard) { animateSwipeOut(activeCard, 'learn'); processResult('learn'); } } });
        closeBtn.addEventListener('click', () => { window.location.href = 'index.html'; });
    </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>Profile</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    img { width: 100px; height: 100px; border-radius: 50%; margin-bottom: 10px; }
    input, button { display: block; margin: 10px 0; padding: 10px; width: 250px; }
  </style>
</head>
<body>
  <h2>Your Profile</h2>
  <img id="profile-img" src="" alt="Profile Image" />
  <input type="file" id="img-upload" />
  <input type="text" id="name" />
  <input type="text" id="mobile" />
  <button onclick="updateProfile()">Update Profile</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import {
      getDatabase,
      ref,
      get,
      set
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";
    import {
      getStorage,
      ref as sRef,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA-P5EbBSTvzINV8DebaYN3AfsAO4Qt7k8",
      authDomain: "demo420-c8c7b.firebaseapp.com",
      databaseURL: "https://demo420-c8c7b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "demo420-c8c7b",
      storageBucket: "demo420-c8c7b.appspot.com",
      messagingSenderId: "76809685599",
      appId: "1:76809685599:web:a4100117563404e392a9ea"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);
    const storage = getStorage(app);

    const imgInput = document.getElementById("img-upload");
    const imgTag = document.getElementById("profile-img");
    const nameInput = document.getElementById("name");
    const mobileInput = document.getElementById("mobile");

    onAuthStateChanged(auth, (user) => {
      if (user) {
        const uid = user.uid;
        const userRef = ref(database, 'users/' + uid);

        get(userRef).then(snapshot => {
          if (snapshot.exists()) {
            const data = snapshot.val();
            nameInput.value = data.name;
            mobileInput.value = data.mobile;
            if (data.photoURL) {
              imgTag.src = data.photoURL;
            } else {
              imgTag.src = "https://via.placeholder.com/100";
            }
          }
        });

        imgInput.addEventListener("change", async () => {
          const file = imgInput.files[0];
          if (!file) return;

          const storageRef = sRef(storage, 'users/' + uid + '/profile.jpg');
          await uploadBytes(storageRef, file);
          const downloadURL = await getDownloadURL(storageRef);
          imgTag.src = downloadURL;

          await set(ref(database, 'users/' + uid + '/photoURL'), downloadURL);
          await updateProfile(user, { photoURL: downloadURL });
        });
      } else {
        window.location.href = "index.html";
      }
    });

    window.updateProfile = () => {
      const user = auth.currentUser;
      if (!user) return;

      const uid = user.uid;
      const name = nameInput.value;
      const mobile = mobileInput.value;

      set(ref(database, 'users/' + uid), {
        name,
        mobile,
        email: user.email,
        photoURL: user.photoURL || ""
      });

      updateProfile(user, { displayName: name });
      alert("Profile updated!");
    }
  </script>
</body>
</html>

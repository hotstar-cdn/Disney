<!DOCTYPE html>
<html>
<head>
  <title>Student - Take Test</title>
</head>
<body>
  <h1 id="testTitle">Loading...</h1>
  <form id="testForm"></form>
  <button onclick="submitAnswers()">Submit</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MSG_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const urlParams = new URLSearchParams(window.location.search);
    const testId = urlParams.get('testId');

    async function loadTest() {
      const docRef = doc(db, "tests", testId);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        document.getElementById("testTitle").innerText = data.title;

        const form = document.getElementById("testForm");
        data.questions.forEach((q, index) => {
          const div = document.createElement("div");
          div.innerHTML = `<p>${index + 1}. ${q.question}</p>`;
          q.options.forEach((opt, i) => {
            div.innerHTML += `
              <input type="radio" name="q${index}" value="${opt}" required> ${opt}<br>
            `;
          });
          form.appendChild(div);
        });
      } else {
        document.getElementById("testTitle").innerText = "Test not found.";
      }
    }

    async function submitAnswers() {
      const form = document.getElementById("testForm");
      const answers = {};
      for (let i = 0; i < form.elements.length; i++) {
        const el = form.elements[i];
        if (el.checked) {
          const qIndex = el.name.replace('q', '');
          answers[qIndex] = el.value;
        }
      }

      await addDoc(collection(db, "responses"), {
        testId,
        answers,
        timestamp: new Date()
      });

      alert("Answers submitted!");
    }

    loadTest();
  </script>
</body>
</html>

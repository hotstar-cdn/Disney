<!-- 1.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Flashcards</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        :root {
            --orange: #fb923c; --green: #10b981; --background: #f0f7ff;
            --text-dark: #1e293b; --text-light: #64748b; --card-bg: #ffffff;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--background); color: var(--text-dark); overflow: hidden; }
        .app-wrapper { display: flex; flex-direction: column; height: 100vh; }
        .app-header { padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .header-info h1 { font-size: 1.25rem; font-weight: 700; margin: 0; }
        .header-info p { font-size: 0.875rem; color: var(--text-light); margin: 0.25rem 0 0 0; }
        #close-btn { width: 36px; height: 36px; border-radius: 50%; background-color: #e2e8f0; border: none; font-size: 1.5rem; color: var(--text-light); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        /* Card Stack Area */
        .card-area {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 1.5rem 5rem; /* Add padding at bottom for stack effect */
            position: relative;
        }
        .flashcard {
            width: 100%;
            max-width: 400px;
            height: 60vh;
            max-height: 450px;
            position: absolute; /* IMPORTANT for stacking */
            transform-style: preserve-3d;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s;
            cursor: pointer;
            will-change: transform, opacity;
        }
        .flashcard.flipped { transform: rotateY(180deg); }
        .card-face {
            position: absolute; height: 100%; width: 100%;
            backface-visibility: hidden; display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 2rem;
            background-color: var(--card-bg); border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1); text-align: center;
        }
        .card-back { transform: rotateY(180deg); }
        .question-text { font-size: 1.75rem; font-weight: 500; line-height: 1.4; }
        .answer-text { font-size: 1.5rem; }
        #hint-btn { background: none; border: none; color: #007bff; font-weight: 500; font-size: 0.875rem; letter-spacing: 0.5px; cursor: pointer; margin-top: auto; padding: 10px; }
        .hint-text { font-style: italic; color: var(--text-light); margin-top: 1rem; font-size: 1rem; }
        
        /* Swipe Out Animations */
        .flashcard.swiped-right { animation: swipe-right 0.5s forwards ease-in-out; }
        .flashcard.swiped-left { animation: swipe-left 0.5s forwards ease-in-out; }
        @keyframes swipe-right { to { transform: translateX(400px) rotate(25deg); opacity: 0; } }
        @keyframes swipe-left { to { transform: translateX(-400px) rotate(-25deg); opacity: 0; } }
        
        .controls-footer { padding: 1.5rem; display: flex; gap: 1rem; justify-content: center; flex-shrink: 0; }
        .control-btn { flex-grow: 1; max-width: 200px; padding: 1rem; border-radius: 999px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s, color 0.2s; background-color: var(--card-bg); }
        .btn-learning { border: 2px solid var(--orange); color: var(--orange); }
        .btn-know { border: 2px solid var(--green); color: var(--green); }
    </style>
</head>
<body>
    <div class="app-wrapper" id="main-container">
        <header class="app-header">
            <div class="header-info">
                <h1 id="chapter-title">Loading...</h1>
                <p id="progress-counter">Loading cards...</p>
            </div>
            <button id="close-btn">Ã—</button>
        </header>

        <main class="card-area" id="card-area">
            <!-- Card stack will be injected here -->
        </main>

        <footer class="controls-footer">
            <button id="learn-btn" class="control-btn btn-learning">Still learning</button>
            <button id="know-btn" class="control-btn btn-know">I know this</button>
        </footer>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="firebase-init.js"></script>
    <script>
        const mainContainer = document.getElementById('main-container');
        const chapterTitleEl = document.getElementById('chapter-title');
        const progressCounterEl = document.getElementById('progress-counter');
        const cardArea = document.getElementById('card-area');
        const knowBtn = document.getElementById('know-btn');
        const learnBtn = document.getElementById('learn-btn');
        const closeBtn = document.getElementById('close-btn');

        let allCards = [];
        let currentIndex = 0;
        let knowCount = 0;
        let learningCount = 0;
        let isAnimating = false;

        function createCardElement(cardData) {
            const cardEl = document.createElement('div');
            cardEl.className = 'flashcard';
            cardEl.innerHTML = `
                <div class="card-face card-front">
                    <p class="question-text">${cardData.question}</p>
                    ${cardData.hint ? `<button class="hint-btn">SHOW A HINT</button>` : ''}
                </div>
                <div class="card-face card-back">
                    <p class="answer-text">${cardData.answer}</p>
                    ${cardData.hint ? `<p class="hint-text">Hint: ${cardData.hint}</p>` : ''}
                </div>`;
            return cardEl;
        }

        function renderCardStack() {
            cardArea.innerHTML = '';
            const cardsToShow = allCards.slice(currentIndex, currentIndex + 3).reverse();

            cardsToShow.forEach((cardData, indexInStack) => {
                const cardEl = createCardElement(cardData);
                const stackPosition = cardsToShow.length - 1 - indexInStack;

                // Style the card based on its position in the stack
                cardEl.style.transform = `scale(${1 - (stackPosition * 0.05)}) translateY(${stackPosition * -15}px)`;
                cardEl.style.zIndex = allCards.length - indexInStack;
                cardEl.style.opacity = '1';

                cardArea.appendChild(cardEl);

                // Add listeners only to the top card
                if (stackPosition === 0) {
                    cardEl.addEventListener('click', () => {
                        if (!isAnimating) cardEl.classList.toggle('flipped');
                    });
                    const hintBtn = cardEl.querySelector('.hint-btn');
                    if(hintBtn) {
                        hintBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            cardEl.querySelector('.hint-text').style.display = 'block';
                            hintBtn.style.display = 'none';
                        });
                    }

                    const hammer = new Hammer(cardEl);
                    hammer.on('swiperight', handleKnow);
                    hammer.on('swipeleft', handleLearn);
                }
            });
        }

        function processSwipe(direction) {
            if (isAnimating) return;
            isAnimating = true;

            const activeCard = cardArea.querySelector('.flashcard:last-child');
            if (!activeCard) return;

            if (direction === 'know') {
                knowCount++;
                activeCard.classList.add('swiped-right');
            } else {
                learningCount++;
                activeCard.classList.add('swiped-left');
            }
            
            currentIndex++;
            progressCounterEl.textContent = `${currentIndex + 1 > allCards.length ? allCards.length : currentIndex + 1} of ${allCards.length} cards`;

            setTimeout(() => {
                if (currentIndex >= allCards.length) {
                    goToScorePage();
                } else {
                    renderCardStack();
                    isAnimating = false;
                }
            }, 500); // Match animation duration
        }

        const handleKnow = () => processSwipe('know');
        const handleLearn = () => processSwipe('learn');

        function goToScorePage() {
            localStorage.setItem('knowCount', knowCount);
            localStorage.setItem('learningCount', learningCount);
            window.location.href = '2.html';
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const code = new URLSearchParams(window.location.search).get('code');
            if (!code) { mainContainer.innerHTML = '<h1>Error: No code found in URL.</h1>'; return; }
            localStorage.setItem('lastCode', code);

            try {
                const docSnap = await db.collection('flashcardSets').doc(code).get();
                if (docSnap.exists) {
                    const data = docSnap.data();
                    chapterTitleEl.textContent = data.chapter;
                    allCards = data.cards || [];
                    progressCounterEl.textContent = `1 of ${allCards.length} cards`;
                    renderCardStack();
                } else {
                     mainContainer.innerHTML = '<h1>Error: Set not found for this code.</h1>';
                }
            } catch (error) {
                console.error("Error fetching document:", error);
                mainContainer.innerHTML = '<h1>Error loading flashcards.</h1>';
            }
        });

        knowBtn.addEventListener('click', handleKnow);
        learnBtn.addEventListener('click', handleLearn);
        closeBtn.addEventListener('click', () => { window.location.href = 'index.html'; });
    </script>
</body>
</html>

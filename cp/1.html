    <!-- ... (keep all the HTML and CSS from the previous 1.html) ... -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    <script src="data.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyAL5f8Mwk0qoaKBdXh0w2isNRCPSfgBL1g", authDomain: "custom-practice-xperts.firebaseapp.com", projectId: "custom-practice-xperts", storageBucket: "custom-practice-xperts.appspot.com", messagingSenderId: "348008678781", appId: "1:348008678781:web:a57738e0b878b4b8d97814", measurementId: "G-D5V8DPLK6F" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', async () => {
            const questionWrapper = document.getElementById('question-wrapper');
            const testTitle = document.getElementById('test-title');
            const submitButton = document.getElementById('submit-test');
            const timerEl = document.getElementById('timer');
            
            const params = new URLSearchParams(window.location.search);
            const chapterCode = params.get('code');
            const questionCount = parseInt(params.get('count')) || 5; 
            const mode = params.get('mode');

            if (!chapterCode) {
                questionWrapper.innerHTML = `<div class="swiper-slide">Error: No chapter code provided.</div>`;
                return;
            }

            const chapterInfo = chapters.find(c => c.code === chapterCode);
            testTitle.textContent = chapterInfo ? chapterInfo.chapter : 'Custom Test';

            let testQuestions = [];
            let userAnswers = {};
            let startTime;
            let timerInterval;

            try {
                // MODIFIED: Logic to handle normal vs re-attempt mode
                if (mode === 'reattempt') {
                    testTitle.textContent += " (Mistakes)";
                    const improvementData = JSON.parse(localStorage.getItem('improvementBookData') || '{}');
                    const mistakeIds = improvementData[chapterCode]?.mistakes || [];

                    if (mistakeIds.length === 0) {
                        questionWrapper.innerHTML = `<div class="swiper-slide"><h1>Congratulations!</h1><p>You have no mistakes to re-attempt in this chapter.</p></div>`;
                        return;
                    }
                    
                    // Firestore's 'in' query is efficient for up to 10 IDs. For more, multiple queries would be needed.
                    // This is a simplified approach.
                    const querySnapshot = await db.collection("questions").where(firebase.firestore.FieldPath.documentId(), 'in', mistakeIds).get();
                    querySnapshot.forEach(doc => testQuestions.push({ id: doc.id, ...doc.data() }));

                } else {
                    // Normal mode: Fetch random questions from the chapter
                    const querySnapshot = await db.collection("questions").where("chapterCode", "==", chapterCode).get();
                    let allQuestions = [];
                    querySnapshot.forEach((doc) => allQuestions.push({ id: doc.id, ...doc.data() }));
                    const shuffled = allQuestions.sort(() => 0.5 - Math.random());
                    testQuestions = shuffled.slice(0, Math.min(questionCount, allQuestions.length));
                }

                if (testQuestions.length === 0) {
                     questionWrapper.innerHTML = `<div class="swiper-slide">No questions found.</div>`;
                     return;
                }

                renderQuestions();
                initializeTest();

            } catch (error) {
                console.error("Error fetching questions: ", error);
                questionWrapper.innerHTML = `<div class="swiper-slide">Error loading questions.</div>`;
            }

            function renderQuestions() {
                 questionWrapper.innerHTML = testQuestions.map((q, index) => `
                    <div class="swiper-slide" data-question-id="${q.id}" data-question-index="${index}">
                        <div class="question-content">
                            <p class="question-number">Q${index + 1}</p>
                            <p class="question-text">${q.question.replace(/\n/g, '<br>')}</p>
                        </div>
                        <div class="options-container">
                            <button class="option-button" data-option="A"><span class="option-label">A</span> ${q.options.A}</button>
                            <button class="option-button" data-option="B"><span class="option-label">B</span> ${q.options.B}</button>
                            <button class="option-button" data-option="C"><span class="option-label">C</span> ${q.options.C}</button>
                            <button class="option-button" data-option="D"><span class="option-label">D</span> ${q.options.D}</button>
                        </div>
                    </div>
                `).join('');
            }

            function startTimer() {
                startTime = Date.now();
                timerInterval = setInterval(() => {
                    const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
                    const minutes = Math.floor(elapsedSeconds / 60).toString().padStart(2, '0');
                    const seconds = (elapsedSeconds % 60).toString().padStart(2, '0');
                    timerEl.textContent = `${minutes}:${seconds}`;
                }, 1000);
            }

            function initializeTest() {
                startTimer();
                const swiper = new Swiper('.swiper', { on: { slideChange: function () { if (this.isEnd) submitButton.style.display = 'block'; else submitButton.style.display = 'none'; } } });

                questionWrapper.addEventListener('click', (e) => {
                    const selectedOption = e.target.closest('.option-button');
                    if (!selectedOption) return;
                    const slide = selectedOption.closest('.swiper-slide');
                    userAnswers[slide.dataset.questionId] = selectedOption.dataset.option;
                    slide.querySelectorAll('.option-button').forEach(btn => btn.classList.remove('selected'));
                    selectedOption.classList.add('selected');
                    if (!swiper.isEnd) setTimeout(() => swiper.slideNext(), 300);
                });

                submitButton.addEventListener('click', () => {
                    clearInterval(timerInterval);
                    const timeTaken = Math.floor((Date.now() - startTime) / 1000);
                    let score = 0;
                    
                    // MODIFIED: Save mistakes to Improvement Book
                    const improvementData = JSON.parse(localStorage.getItem('improvementBookData') || '{}');
                    if (!improvementData[chapterCode]) {
                        improvementData[chapterCode] = { mistakes: [] };
                    }
                    let chapterMistakes = new Set(improvementData[chapterCode].mistakes);

                    testQuestions.forEach(q => {
                        const userAnswer = userAnswers[q.id];
                        if (userAnswer === q.correctAnswer) {
                            score++;
                            // If in re-attempt mode and answered correctly, remove from mistakes
                            if (mode === 'reattempt') {
                                chapterMistakes.delete(q.id);
                            }
                        } else if (userAnswer) {
                            // If answered incorrectly, add to mistakes
                            chapterMistakes.add(q.id);
                        }
                    });

                    improvementData[chapterCode].mistakes = Array.from(chapterMistakes);
                    localStorage.setItem('improvementBookData', JSON.stringify(improvementData));

                    const results = { score, totalQuestions: testQuestions.length, attemptedQuestions: Object.keys(userAnswers).length, timeTaken, chapterName: chapterInfo.chapter, chapterCode: chapterInfo.code, testData: testQuestions, userAnswers: userAnswers };
                    localStorage.setItem('lastTestResults', JSON.stringify(results));
                    window.location.href = '2.html';
                });
            }
        });
    </script>
